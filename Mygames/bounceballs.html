<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Elasticity Simulation</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        canvas {
            display: block;
            touch-action: none; /* Prevent scrolling on mobile */
        }

        #start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            cursor: pointer;
            backdrop-filter: blur(5px);
        }

        h1 {
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        p {
            color: #aaa;
        }

        /* --- UI CONTROLS --- */
        
        .panel {
            position: absolute;
            z-index: 5;
            background: rgba(30, 30, 30, 0.6);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease; /* Smooth transition for responsiveness */
        }

        /* Bottom Left Controls (Speed & Size) */
        #bottom-controls {
            bottom: 20px;
            left: 20px;
        }

        /* Bottom Right Controls (Sound) */
        #sound-controls {
            bottom: 20px;
            right: 20px;
            align-items: flex-end;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: #ccc;
        }
        
        .control-row label {
            width: 45px;
            text-align: right;
        }

        input[type=range] {
            cursor: pointer;
            accent-color: #00d2ff;
            width: 120px;
        }
        
        .value-display {
            font-family: monospace;
            color: #00d2ff;
            min-width: 35px;
            text-align: right;
        }

        .info-text {
            font-size: 11px;
            color: #777;
            margin-top: 5px;
            text-align: center;
            width: 100%;
        }
        
        .panel-title {
            font-size: 12px;
            color: #777;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            width: 100%;
            text-align: center;
        }

        /* Sound Wave Buttons */
        .wave-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .wave-btn {
            background: rgba(50, 50, 50, 0.6);
            border: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
            padding: 5px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            font-family: inherit;
            transition: all 0.2s;
            min-width: 40px;
        }

        .wave-btn:hover {
            background: rgba(70, 70, 70, 0.8);
        }

        .wave-btn.active {
            background: rgba(0, 210, 255, 0.2);
            color: #00d2ff;
            border-color: rgba(0, 210, 255, 0.4);
            font-weight: bold;
        }

        /* Top Right Controls (Add Ball & Colors) */
        #top-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            z-index: 5;
            transition: all 0.3s ease;
        }

        #spawn-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(30, 30, 30, 0.6);
            padding: 8px 12px;
            border-radius: 25px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .swatches {
            display: flex;
            gap: 5px;
        }

        .swatch {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }

        .swatch:hover {
            transform: scale(1.1);
        }

        .swatch.active {
            border-color: white;
            transform: scale(1.2);
            box-shadow: 0 0 8px rgba(255,255,255,0.5);
        }

        .action-btn {
            background: rgba(50, 50, 50, 0.8);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: scale(1.05);
            background: rgba(70, 70, 70, 0.9);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        #add-ball-btn {
            color: #00d2ff;
            background: transparent;
            border: 1px solid #00d2ff;
        }
        
        #add-ball-btn:hover {
            background: rgba(0, 210, 255, 0.1);
        }

        #collision-btn {
            width: 100%;
            color: #aaa;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(4px);
        }

        #collision-btn.active {
            color: #00d2ff;
            background: rgba(0, 210, 255, 0.1);
            border-color: rgba(0, 210, 255, 0.3);
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            /* Move Audio to Right side, below Top Controls, to avoid Top Left */
            #sound-controls {
                bottom: auto;
                right: 20px;
                top: 150px; /* Positioned below the top-right controls */
                left: auto;
                align-items: flex-end;
            }

            /* Scale down panels */
            .panel {
                padding: 10px;
                gap: 5px;
                transform-origin: center;
                transform: scale(0.95);
            }
            
            /* Scale down top controls */
            #top-controls {
                transform-origin: top right;
                transform: scale(0.9);
            }

            /* Make sliders smaller to fit width */
            input[type=range] {
                width: 80px;
            }
            
            .control-row {
                font-size: 12px;
                gap: 8px;
            }
            
            .control-row label {
                width: 35px;
            }
            
            #add-ball-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .swatch {
                width: 16px;
                height: 16px;
            }
        }

    </style>
</head>
<body>

    <div id="start-overlay">
        <h1>SIMULATION</h1>
        <p>Click anywhere to start</p>
    </div>

    <!-- Top Right: Spawn Controls & Collision Toggle -->
    <div id="top-controls">
        <div id="spawn-group">
            <div class="swatches" id="colorSwatches">
                <div class="swatch active" data-hue="180" style="background: hsl(180, 100%, 50%)"></div> <!-- Cyan -->
                <div class="swatch" data-hue="225" style="background: hsl(225, 100%, 50%)"></div> <!-- Blue -->
                <div class="swatch" data-hue="0" style="background: hsl(0, 100%, 50%)"></div>   <!-- Red -->
                <div class="swatch" data-hue="45" style="background: hsl(45, 100%, 50%)"></div>  <!-- Gold -->
                <div class="swatch" data-hue="120" style="background: hsl(120, 100%, 50%)"></div> <!-- Green -->
                <div class="swatch" data-hue="280" style="background: hsl(280, 100%, 50%)"></div> <!-- Purple -->
            </div>
            <button id="add-ball-btn" class="action-btn">Add Ball</button>
        </div>
        <button id="collision-btn" class="action-btn">Collisions: OFF</button>
    </div>

    <!-- Bottom Left: Speed & Size -->
    <div id="bottom-controls" class="panel">
        <div class="panel-title">Physics</div>
        <div class="control-row">
            <label for="speedSlider">Speed</label>
            <input type="range" id="speedSlider" min="0.1" max="2.0" step="0.1" value="0.1">
            <span id="speedValue" class="value-display">0.1x</span>
        </div>
        <div class="control-row">
            <label for="sizeSlider">Size</label>
            <input type="range" id="sizeSlider" min="7.5" max="15" step="0.5" value="15">
            <span id="sizeValue" class="value-display">15</span>
        </div>
        <div class="info-text">Tap balls to pop them!</div>
    </div>

    <!-- Bottom Right (Moves to Top Left on Mobile): Sound Controls -->
    <div id="sound-controls" class="panel">
        <div class="panel-title">Audio</div>
        <div class="wave-selector">
            <button class="wave-btn active" data-wave="sine">Sine</button>
            <button class="wave-btn" data-wave="triangle">Tri</button>
            <button class="wave-btn" data-wave="square">Sqr</button>
            <button class="wave-btn" data-wave="sawtooth">Saw</button>
        </div>
        <div class="control-row">
            <label for="pitchSlider">Pitch</label>
            <input type="range" id="pitchSlider" min="50" max="600" step="10" value="220">
        </div>
        <div class="control-row">
            <label for="decaySlider">Decay</label>
            <input type="range" id="decaySlider" min="0.1" max="1.5" step="0.1" value="0.3">
        </div>
    </div>

    <canvas id="simCanvas"></canvas>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('start-overlay');
        
        // Physics Controls
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const sizeSlider = document.getElementById('sizeSlider');
        const sizeValue = document.getElementById('sizeValue');
        
        // Action Controls
        const addBallBtn = document.getElementById('add-ball-btn');
        const collisionBtn = document.getElementById('collision-btn');
        const swatches = document.querySelectorAll('.swatch');
        
        // Sound Controls
        const waveBtns = document.querySelectorAll('.wave-btn');
        const pitchSlider = document.getElementById('pitchSlider');
        const decaySlider = document.getElementById('decaySlider');

        // Configuration
        const config = {
            gravity: 0.6,         
            friction: 0.0,        
            bounce: 1.0,          
            subSteps: 16,         
            containerThickness: 5,
            ballCollisions: false,
            // Sound Config
            soundType: 'sine',
            basePitch: 220,
            decay: 0.3
        };

        // State
        let width, height;
        let centerX, centerY;
        let containerRadius;
        let isRunning = false;
        let animationId;
        let balls = [];
        let particles = [];
        let selectedHue = 180; // Default cyan

        // Audio Context
        let audioCtx;

        // --- Event Listeners ---

        speedSlider.addEventListener('input', (e) => {
            speedValue.textContent = parseFloat(e.target.value).toFixed(1) + 'x';
        });

        sizeSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            sizeValue.textContent = val.toFixed(1);
            balls.forEach(b => b.radius = val);
        });

        collisionBtn.addEventListener('click', () => {
            config.ballCollisions = !config.ballCollisions;
            if (config.ballCollisions) {
                collisionBtn.textContent = "Collisions: ON";
                collisionBtn.classList.add('active');
            } else {
                collisionBtn.textContent = "Collisions: OFF";
                collisionBtn.classList.remove('active');
            }
        });

        swatches.forEach(swatch => {
            swatch.addEventListener('click', (e) => {
                swatches.forEach(s => s.classList.remove('active'));
                e.target.classList.add('active');
                selectedHue = parseInt(e.target.getAttribute('data-hue'));
            });
        });

        // Sound Control Listeners
        waveBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                waveBtns.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                config.soundType = e.target.getAttribute('data-wave');
            });
        });

        pitchSlider.addEventListener('input', (e) => {
            config.basePitch = parseInt(e.target.value);
        });

        decaySlider.addEventListener('input', (e) => {
            config.decay = parseFloat(e.target.value);
        });

        // Ball Interaction
        function handleInteraction(clientX, clientY) {
            if (!isRunning) return;
            for (let i = balls.length - 1; i >= 0; i--) {
                const b = balls[i];
                const dx = clientX - b.x;
                const dy = clientY - b.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < b.radius + 10) {
                    popBall(i);
                    return; 
                }
            }
        }

        canvas.addEventListener('mousedown', (e) => handleInteraction(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            const touch = e.touches[0];
            handleInteraction(touch.clientX, touch.clientY);
        }, {passive: false});


        // --- Audio System ---

        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }

        function playBounceSound(speed) {
            if (!audioCtx || audioCtx.state === 'suspended') return;

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const speedFactor = Math.min(speed, 25); 
            // Use configured base pitch with slight random variation
            const randomVariance = Math.random() * 50 - 25;
            osc.frequency.value = config.basePitch + randomVariance + (speedFactor * 10);
            osc.type = config.soundType;

            const now = audioCtx.currentTime;
            gainNode.gain.setValueAtTime(0, now);
            
            // Attack
            gainNode.gain.linearRampToValueAtTime(Math.min(speed/20, 0.4), now + 0.01);
            
            // Release (Decay)
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + config.decay);

            osc.start(now);
            osc.stop(now + config.decay);
        }

        function playPopSound() {
            if (!audioCtx || audioCtx.state === 'suspended') return;

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
            osc.type = 'triangle';

            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);

            osc.start(now);
            osc.stop(now + 0.1);
        }

        // --- Game Logic ---

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            containerRadius = Math.min(width, height) * 0.4;

            if (!isRunning) {
                balls = [];
                spawnBall();
            }
        }

        function spawnBall() {
            const currentRadius = parseFloat(sizeSlider.value);
            const x = centerX;
            const y = centerY - containerRadius + currentRadius + 2;
            
            const hueVar = selectedHue + (Math.random() * 30 - 15);
            const lightVar = 40 + Math.random() * 20;
            const color = `hsl(${hueVar}, 100%, ${lightVar}%)`;

            balls.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 8, 
                vy: 0,
                radius: currentRadius,
                color: color,
                trail: []
            });
        }

        function popBall(index) {
            const b = balls[index];
            createParticles(b.x, b.y, b.color);
            playPopSound();
            balls.splice(index, 1);
        }

        function createParticles(x, y, color) {
            for(let i=0; i<12; i++) {
                const angle = (Math.PI * 2 / 12) * i;
                const speed = 2 + Math.random() * 3;
                particles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1.0,
                    color: color
                });
            }
        }

        function update() {
            const timeScale = parseFloat(speedSlider.value);
            const dt = timeScale / config.subSteps;
            
            for (let k = 0; k < config.subSteps; k++) {
                
                balls.forEach(ball => {
                    ball.vy += config.gravity * dt;
                    
                    if (config.friction > 0) {
                        ball.vx *= (1 - config.friction * dt);
                        ball.vy *= (1 - config.friction * dt);
                    }

                    ball.x += ball.vx * dt;
                    ball.y += ball.vy * dt;

                    // Wall Collision
                    const dx = ball.x - centerX;
                    const dy = ball.y - centerY;
                    const distFromCenter = Math.sqrt(dx * dx + dy * dy);

                    if (distFromCenter + ball.radius > containerRadius) {
                        const nx = -dx / distFromCenter;
                        const ny = -dy / distFromCenter;
                        const overlap = distFromCenter + ball.radius - containerRadius;
                        
                        ball.x += nx * overlap;
                        ball.y += ny * overlap;

                        const dotProduct = ball.vx * nx + ball.vy * ny;
                        
                        if (dotProduct < 0) {
                            ball.vx = ball.vx - 2 * dotProduct * nx;
                            ball.vy = ball.vy - 2 * dotProduct * ny;
                            ball.vx *= config.bounce;
                            ball.vy *= config.bounce;
                            
                            const speed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy);
                            playBounceSound(speed);
                        }
                    }
                });

                // Ball-to-Ball Collision
                if (config.ballCollisions) {
                    for (let i = 0; i < balls.length; i++) {
                        for (let j = i + 1; j < balls.length; j++) {
                            const b1 = balls[i];
                            const b2 = balls[j];
                            
                            const dx = b2.x - b1.x;
                            const dy = b2.y - b1.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const minDistance = b1.radius + b2.radius;

                            if (distance < minDistance) {
                                const nx = dx / distance;
                                const ny = dy / distance;
                                const overlap = minDistance - distance;
                                
                                const separationX = nx * overlap * 0.5;
                                const separationY = ny * overlap * 0.5;
                                
                                b1.x -= separationX;
                                b1.y -= separationY;
                                b2.x += separationX;
                                b2.y += separationY;

                                const dvx = b1.vx - b2.vx;
                                const dvy = b1.vy - b2.vy;
                                const p = dvx * nx + dvy * ny;

                                if (p > 0) {
                                    b1.vx -= p * nx;
                                    b1.vy -= p * ny;
                                    b2.vx += p * nx;
                                    b2.vy += p * ny;
                                    playBounceSound(Math.abs(p));
                                }
                            }
                        }
                    }
                }
            }

            // Update Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx * timeScale;
                p.y += p.vy * timeScale;
                p.life -= 0.05 * timeScale;
                if(p.life <= 0) particles.splice(i, 1);
            }

            // Trail Logic
            if (frameCount % 2 === 0) {
                balls.forEach(ball => {
                    ball.trail.push({x: ball.x, y: ball.y});
                    if (ball.trail.length > 20) ball.trail.shift();
                });
            }
        }

        let frameCount = 0;

        function draw() {
            ctx.fillStyle = '#111'; 
            ctx.fillRect(0, 0, width, height);

            // Container
            ctx.beginPath();
            ctx.arc(centerX, centerY, containerRadius, 0, Math.PI * 2);
            ctx.strokeStyle = '#444';
            ctx.lineWidth = config.containerThickness;
            ctx.stroke();
            
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#444';
            ctx.stroke();
            ctx.shadowBlur = 0;

            // Balls
            balls.forEach(ball => {
                if (ball.trail.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(ball.trail[0].x, ball.trail[0].y);
                    for (let i = 1; i < ball.trail.length; i++) {
                        ctx.lineTo(ball.trail[i].x, ball.trail[i].y);
                    }
                    ctx.strokeStyle = ball.color.replace('hsl', 'hsla').replace(')', ', 0.3)'); 
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
                ctx.fillStyle = ball.color;
                ctx.fill();
                
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(ball.x - ball.radius*0.3, ball.y - ball.radius*0.3, ball.radius/3, 0, Math.PI * 2);
                ctx.fill();
            });

            // Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            });
        }

        function loop() {
            if (!isRunning) return;
            frameCount++;
            update();
            draw();
            animationId = requestAnimationFrame(loop);
        }

        // Add Ball Button
        addBallBtn.addEventListener('click', () => {
            if(!isRunning) {
               if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
               else if(!audioCtx) initAudio();
               
               overlay.style.opacity = '0';
               setTimeout(() => overlay.style.display = 'none', 500);
               resize(); 
               isRunning = true;
               loop();
               spawnBall(); 
            } else {
                spawnBall();
            }
        });

        // Start Handler
        overlay.addEventListener('click', () => {
            if (isRunning) return;
            initAudio(); 
            if(audioCtx) audioCtx.resume();
            
            overlay.style.opacity = '0';
            setTimeout(() => overlay.style.display = 'none', 500);
            resize();
            isRunning = true;
            loop();
        });

        window.addEventListener('resize', resize);
        
        resize();
        
        // Initial visual setup
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, width, height);
        ctx.beginPath();
        ctx.arc(centerX, centerY, containerRadius, 0, Math.PI * 2);
        ctx.strokeStyle = '#444';
        ctx.lineWidth = config.containerThickness;
        ctx.stroke();

    </script>
</body>
</html>
