<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Synth Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        
        .btn-active {
            transform: scale(0.95);
            filter: brightness(1.5);
            box-shadow: 0 0 15px currentColor;
        }

        /* Synth Keys */
        .piano-key { transition: all 0.1s ease; cursor: pointer; }
        .white-key {
            background: linear-gradient(to bottom, #f1f5f9 0%, #cbd5e1 100%);
            height: 12rem; z-index: 1; border-radius: 0 0 0.5rem 0.5rem;
        }
        .white-key.active {
            background: linear-gradient(to bottom, #94a3b8 0%, #cbd5e1 100%);
            transform: scaleY(0.98); transform-origin: top; box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .black-key {
            background: linear-gradient(to bottom, #334155 0%, #0f172a 100%);
            height: 7rem; z-index: 2; position: absolute; width: 60%; left: 70%;
            border-radius: 0 0 0.3rem 0.3rem; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .black-key.active {
            background: linear-gradient(to bottom, #1e293b 0%, #000000 100%);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5); border: 1px solid #3b82f6;
        }

        /* Sequencer Styles */
        .seq-step {
            transition: all 0.1s;
        }
        .seq-step.active {
            background-color: #06b6d4; /* Cyan-500 */
            box-shadow: 0 0 8px #06b6d4;
        }
        .seq-step.playing {
            border: 2px solid white;
            transform: scale(1.1);
        }
        .seq-step:hover {
            background-color: #475569;
        }
        .seq-step.active:hover {
            background-color: #22d3ee;
        }

        /* Classic Piano Theme Overrides */
        .classic-theme .white-key {
            background: linear-gradient(to bottom, #ffffff 0%, #f0f0f0 100%);
            border: 1px solid #ccc;
        }
        .classic-theme .white-key.active {
            background: #e0e0e0;
        }
        .classic-theme .black-key {
            background: linear-gradient(to bottom, #1a1a1a 0%, #000000 100%);
        }
        
        body {
            background-color: #0f172a; color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none;
        }
        
        .tab-btn {
            @apply px-4 py-2 rounded-t-lg font-bold text-sm transition-colors border-b-2 border-transparent;
        }
        .tab-btn.active {
            @apply bg-slate-800 text-cyan-400 border-cyan-400;
        }
        .tab-btn:not(.active) {
            @apply text-slate-500 hover:text-slate-300 hover:bg-slate-800/50;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 select-none">

    <!-- Header & Visualizer -->
    <div class="w-full max-w-4xl mb-4 relative group">
        <div class="absolute inset-0 bg-blue-500 rounded-xl opacity-10 blur-xl group-hover:opacity-20 transition-opacity duration-500"></div>
        <div class="relative bg-slate-900 border border-slate-700 rounded-xl overflow-hidden shadow-2xl">
            <div class="absolute inset-0 scanlines z-10"></div>
            <div class="p-4 flex justify-between items-center border-b border-slate-800 bg-slate-800/50 backdrop-blur">
                <div>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">NEON AUDIO ENGINE</h1>
                    <p class="text-xs text-slate-400">Web Audio API â€¢ Procedural Sound</p>
                </div>
                <div class="flex gap-2">
                    <div class="h-2 w-2 rounded-full bg-red-500 animate-pulse" id="status-light"></div>
                    <div class="text-xs font-mono text-cyan-400" id="status-text">CLICK TO ACTIVATE</div>
                </div>
            </div>
            <canvas id="visualizer" class="w-full h-32 bg-black/80 block"></canvas>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="w-full max-w-4xl flex border-b border-slate-700 mb-6">
        <button onclick="switchTab('pad')" id="tab-pad" class="tab-btn active">BEAT PAD</button>
        <button onclick="switchTab('keyboard')" id="tab-keyboard" class="tab-btn">SYNTH</button>
        <button onclick="switchTab('piano')" id="tab-piano" class="tab-btn">GRAND PIANO</button>
    </div>

    <!-- VIEW 1: PAD CONTROLS -->
    <div id="pad-view" class="w-full max-w-4xl grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <!-- Rhythm -->
        <div class="col-span-2 md:col-span-1 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
            <h2 class="text-xs uppercase tracking-widest text-slate-500 mb-3 font-bold">Rhythm</h2>
            <div class="grid grid-cols-2 gap-3">
                <button data-key="q" onclick="playSound('kick')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-pink-600 to-rose-700 hover:from-pink-500 hover:to-rose-600 shadow-lg shadow-rose-900/20 transition-all active:scale-95 flex flex-col items-center justify-center group relative overflow-hidden">
                    <span class="text-xl font-bold">Kick</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[Q]</span>
                </button>
                <button data-key="w" onclick="playSound('snare')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 shadow-lg shadow-orange-900/20 transition-all active:scale-95 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-xl font-bold">Snare</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[W]</span>
                </button>
                <button data-key="e" onclick="playSound('hihat')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-amber-400 to-orange-500 hover:from-amber-300 hover:to-orange-400 shadow-lg shadow-amber-900/20 text-slate-900 transition-all active:scale-95 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-xl font-bold">Hi-Hat</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[E]</span>
                </button>
                <button data-key="r" onclick="playSound('clap')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-yellow-400 to-amber-500 hover:from-yellow-300 hover:to-amber-400 shadow-lg shadow-yellow-900/20 text-slate-900 transition-all active:scale-95 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-xl font-bold">Clap</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[R]</span>
                </button>
            </div>
        </div>
        <!-- Bass -->
        <div class="col-span-2 md:col-span-1 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
            <h2 class="text-xs uppercase tracking-widest text-slate-500 mb-3 font-bold">Bass</h2>
            <div class="grid grid-cols-1 gap-3 h-full">
                <button data-key="a" onclick="playSound('bass1')" class="pad-btn h-full rounded-lg bg-gradient-to-br from-violet-600 to-purple-700 hover:from-violet-500 hover:to-purple-600 shadow-lg shadow-purple-900/20 transition-all active:scale-95 flex items-center justify-between px-6 relative overflow-hidden">
                    <span class="text-lg font-bold">Deep Sub</span><span class="text-xs opacity-50">[A]</span>
                </button>
                <button data-key="s" onclick="playSound('bass2')" class="pad-btn h-full rounded-lg bg-gradient-to-br from-purple-600 to-fuchsia-700 hover:from-purple-500 hover:to-fuchsia-600 shadow-lg shadow-fuchsia-900/20 transition-all active:scale-95 flex items-center justify-between px-6 relative overflow-hidden">
                    <span class="text-lg font-bold">Grit Bass</span><span class="text-xs opacity-50">[S]</span>
                </button>
            </div>
        </div>
        <!-- Synth -->
        <div class="col-span-2 md:col-span-1 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
            <h2 class="text-xs uppercase tracking-widest text-slate-500 mb-3 font-bold">Melody</h2>
            <div class="grid grid-cols-2 gap-3">
                <button data-key="d" onclick="playSound('chord1')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 shadow-lg shadow-blue-900/20 transition-all active:scale-95 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-xl font-bold">C Maj7</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[D]</span>
                </button>
                <button data-key="f" onclick="playSound('chord2')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-sky-500 to-indigo-600 hover:from-sky-400 hover:to-indigo-500 shadow-lg shadow-indigo-900/20 transition-all active:scale-95 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-xl font-bold">A Min7</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[F]</span>
                </button>
                <button data-key="z" onclick="playSound('lead')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-teal-400 to-emerald-600 hover:from-teal-300 hover:to-emerald-500 shadow-lg shadow-emerald-900/20 text-slate-900 transition-all active:scale-95 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-xl font-bold">Lead</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[Z]</span>
                </button>
                <button data-key="x" onclick="playSound('pad')" class="pad-btn h-20 rounded-lg bg-gradient-to-br from-emerald-400 to-green-600 hover:from-emerald-300 hover:to-green-500 shadow-lg shadow-green-900/20 text-slate-900 transition-all active:scale-95 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-xl font-bold">Cosmic</span><span class="text-xs opacity-50 absolute bottom-1 right-2">[X]</span>
                </button>
            </div>
        </div>
        <!-- FX -->
        <div class="col-span-2 md:col-span-1 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
            <h2 class="text-xs uppercase tracking-widest text-slate-500 mb-3 font-bold">FX</h2>
            <div class="grid grid-cols-1 gap-3 h-full">
                <button data-key="c" onclick="playSound('laser')" class="pad-btn h-full rounded-lg border-2 border-dashed border-slate-600 hover:border-cyan-400 hover:bg-slate-700/50 text-slate-400 hover:text-cyan-400 transition-all active:scale-95 flex items-center justify-center relative overflow-hidden">
                    <span class="text-lg font-mono">LASER</span><span class="text-xs opacity-50 absolute bottom-2 right-2">[C]</span>
                </button>
                <button data-key="v" onclick="playSound('coin')" class="pad-btn h-full rounded-lg border-2 border-dashed border-slate-600 hover:border-yellow-400 hover:bg-slate-700/50 text-slate-400 hover:text-yellow-400 transition-all active:scale-95 flex items-center justify-center relative overflow-hidden">
                    <span class="text-lg font-mono">8-BIT COIN</span><span class="text-xs opacity-50 absolute bottom-2 right-2">[V]</span>
                </button>
            </div>
        </div>

        <!-- NEW: SEQUENCER SECTION -->
        <div class="col-span-2 md:col-span-4 bg-slate-800/80 p-4 rounded-xl border border-slate-700 shadow-xl mt-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-cyan-400 uppercase tracking-widest">Loop Sequencer</h3>
                
                <div class="flex gap-4 items-center">
                    <div class="flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-lg border border-slate-700">
                         <span class="text-xs text-slate-500">BPM</span>
                         <input type="range" min="60" max="180" value="120" id="bpm-slider" class="w-24 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                         <span id="bpm-display" class="text-xs font-mono text-white w-6">120</span>
                    </div>

                    <button id="btn-play" onclick="toggleSequencer()" class="px-4 py-1 rounded bg-green-600 hover:bg-green-500 text-white text-xs font-bold uppercase transition-colors">Play</button>
                    <button onclick="clearSequencer()" class="px-4 py-1 rounded bg-slate-700 hover:bg-red-500/80 text-white text-xs font-bold uppercase transition-colors">Clear</button>
                </div>
            </div>

            <div id="sequencer-grid" class="flex flex-col gap-1 w-full overflow-x-auto pb-2">
                <!-- Grid generated by JS -->
            </div>
        </div>
    </div>

    <!-- VIEW 2: SYNTH KEYBOARD (Initially Hidden) -->
    <div id="keyboard-view" class="w-full max-w-4xl hidden mb-8">
        <div class="bg-slate-800/80 p-6 rounded-xl border border-slate-700 shadow-2xl relative">
            <div class="flex gap-4 mb-6 justify-center">
                <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-1">Waveform</div>
                    <select id="waveform-select" onchange="updateWaveform(this.value)" class="bg-slate-800 text-cyan-400 text-sm rounded border border-slate-600 p-1 outline-none focus:border-cyan-400">
                        <option value="sawtooth">Sawtooth (Synth)</option>
                        <option value="square">Square (8-Bit)</option>
                        <option value="triangle">Triangle (Soft)</option>
                        <option value="sine">Sine (Pure)</option>
                    </select>
                </div>
                 <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                    <div class="text-xs text-slate-400 uppercase tracking-wide mb-1">Range</div>
                    <div class="text-sm font-mono text-cyan-400">C3 - E4</div>
                </div>
            </div>
            <!-- Keys Container (Reused structure in JS) -->
            <div class="relative h-48 flex justify-center select-none synth-keys-container"></div>
            <div class="mt-4 text-center text-xs text-slate-400">Use top row keys [W, E, T, Y, U...] for flats/sharps and middle row [A, S, D, F...] for naturals.</div>
        </div>
    </div>

    <!-- VIEW 3: GRAND PIANO (Initially Hidden) -->
    <div id="piano-view" class="w-full max-w-4xl hidden mb-8">
        <div class="bg-amber-950 p-2 rounded-xl border-4 border-amber-900 shadow-2xl relative">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/wood-pattern.png')] opacity-30 pointer-events-none rounded-lg"></div>
            
            <div class="bg-black/40 p-3 rounded-t-lg flex justify-between items-center mb-1 relative z-10">
                <div class="text-amber-100 font-serif tracking-widest text-lg font-bold">SteinWay Sim</div>
                <div class="text-amber-200/50 text-xs uppercase">Procedural Acoustics</div>
            </div>

            <!-- Piano Keys Container -->
            <div class="relative h-56 flex justify-center select-none classic-theme piano-keys-container bg-black p-1 rounded-b-lg"></div>
            
            <div class="mt-4 text-center text-xs text-amber-200/50 font-serif">
                Simulates hammer strikes and triple-string detuning.
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div id="instr-pad" class="text-center text-slate-500 text-sm max-w-lg">
        <p>Mode: <span class="text-cyan-400">Beat Pad</span>. Click grid to program beat. Press keys or pads to play.</p>
    </div>
    <!-- Fixed ID here: instr-key -> instr-keyboard -->
    <div id="instr-keyboard" class="text-center text-slate-500 text-sm max-w-lg hidden">
         <p>Mode: <span class="text-cyan-400">Synth</span>. Use middle and top rows to play.</p>
    </div>
    <div id="instr-piano" class="text-center text-slate-500 text-sm max-w-lg hidden">
         <p>Mode: <span class="text-amber-400">Grand Piano</span>. Use middle and top rows to play.</p>
    </div>

    <script>
        // --- Globals & State ---
        let audioCtx;
        let masterGain;
        let analyser;
        let isInit = false;
        let currentTab = 'pad';
        let currentWaveform = 'sawtooth';

        // --- Sequencer Globals ---
        let isPlaying = false;
        let tempo = 120.0;
        let lookahead = 25.0; // How frequently to call scheduling function (ms)
        let scheduleAheadTime = 0.1; // How far ahead to schedule audio (sec)
        let nextNoteTime = 0.0; // when the next note is due.
        let current16thNote = 0; // 0-15 loop
        let timerID;
        // Grid: 6 rows (instruments) x 16 columns
        // Rows: Kick, Snare, HiHat, Clap, Bass1, Bass2
        const seqInstruments = ['kick', 'snare', 'hihat', 'clap', 'bass1', 'bass2'];
        let sequencerState = Array(6).fill().map(() => Array(16).fill(false));

        // --- Keyboard Data ---
        const pianoFrequencies = {
            'a': 130.81, 'w': 138.59, 's': 146.83, 'e': 155.56, 'd': 164.81, 'f': 174.61,
            't': 185.00, 'g': 196.00, 'y': 207.65, 'h': 220.00, 'u': 233.08, 'j': 246.94,
            'k': 261.63, 'o': 277.18, 'l': 293.66, 'p': 311.13, ';': 329.63
        };
        const keyToNoteName = {
            'a': 'C3', 'w': 'C#3', 's': 'D3', 'e': 'D#3', 'd': 'E3', 'f': 'F3',
            't': 'F#3', 'g': 'G3', 'y': 'G#3', 'h': 'A3', 'u': 'A#3', 'j': 'B3',
            'k': 'C4', 'o': 'C#4', 'l': 'D4', 'p': 'D#4', ';': 'E4'
        };

        // Map for pad
        const padKeyMap = {
            'q': 'kick', 'w': 'snare', 'e': 'hihat', 'r': 'clap',
            'a': 'bass1', 's': 'bass2', 'd': 'chord1', 'f': 'chord2',
            'z': 'lead', 'x': 'pad', 'c': 'laser', 'v': 'coin'
        };

        // --- DOM Generation ---
        function generateKeys(containerClass) {
            const containers = document.querySelectorAll(containerClass);
            containers.forEach(container => {
                let html = '';
                // Manual HTML construction (omitted for brevity, same as before)
                // ... (Using the same HTML string construction for reliability)
                html += `<div class="relative w-12 sm:w-14"><div data-note="C3" onmousedown="handleNoteInput('a')" onmouseup="handleNoteRelease('a')" onmouseleave="handleNoteRelease('a')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">A</div><div data-note="C#3" onmousedown="handleNoteInput('w')" onmouseup="handleNoteRelease('w')" onmouseleave="handleNoteRelease('w')" class="piano-key black-key"></div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="D3" onmousedown="handleNoteInput('s')" onmouseup="handleNoteRelease('s')" onmouseleave="handleNoteRelease('s')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">S</div><div data-note="D#3" onmousedown="handleNoteInput('e')" onmouseup="handleNoteRelease('e')" onmouseleave="handleNoteRelease('e')" class="piano-key black-key"></div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="E3" onmousedown="handleNoteInput('d')" onmouseup="handleNoteRelease('d')" onmouseleave="handleNoteRelease('d')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">D</div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="F3" onmousedown="handleNoteInput('f')" onmouseup="handleNoteRelease('f')" onmouseleave="handleNoteRelease('f')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">F</div><div data-note="F#3" onmousedown="handleNoteInput('t')" onmouseup="handleNoteRelease('t')" onmouseleave="handleNoteRelease('t')" class="piano-key black-key"></div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="G3" onmousedown="handleNoteInput('g')" onmouseup="handleNoteRelease('g')" onmouseleave="handleNoteRelease('g')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">G</div><div data-note="G#3" onmousedown="handleNoteInput('y')" onmouseup="handleNoteRelease('y')" onmouseleave="handleNoteRelease('y')" class="piano-key black-key"></div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="A3" onmousedown="handleNoteInput('h')" onmouseup="handleNoteRelease('h')" onmouseleave="handleNoteRelease('h')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">H</div><div data-note="A#3" onmousedown="handleNoteInput('u')" onmouseup="handleNoteRelease('u')" onmouseleave="handleNoteRelease('u')" class="piano-key black-key"></div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="B3" onmousedown="handleNoteInput('j')" onmouseup="handleNoteRelease('j')" onmouseleave="handleNoteRelease('j')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">J</div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="C4" onmousedown="handleNoteInput('k')" onmouseup="handleNoteRelease('k')" onmouseleave="handleNoteRelease('k')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">K</div><div data-note="C#4" onmousedown="handleNoteInput('o')" onmouseup="handleNoteRelease('o')" onmouseleave="handleNoteRelease('o')" class="piano-key black-key"></div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="D4" onmousedown="handleNoteInput('l')" onmouseup="handleNoteRelease('l')" onmouseleave="handleNoteRelease('l')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">L</div><div data-note="D#4" onmousedown="handleNoteInput('p')" onmouseup="handleNoteRelease('p')" onmouseleave="handleNoteRelease('p')" class="piano-key black-key"></div></div>`;
                html += `<div class="relative w-12 sm:w-14"><div data-note="E4" onmousedown="handleNoteInput(';')" onmouseup="handleNoteRelease(';')" onmouseleave="handleNoteRelease(';')" class="piano-key white-key w-full border-r border-slate-400 absolute top-0 left-0 rounded-r-lg"></div><div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-500 text-xs pointer-events-none">;</div></div>`;
                container.innerHTML = html;
            });
        }
        
        generateKeys('.synth-keys-container');
        generateKeys('.piano-keys-container');

        function renderSequencer() {
            const grid = document.getElementById('sequencer-grid');
            grid.innerHTML = '';
            
            seqInstruments.forEach((inst, rowIdx) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-1 min-w-max';
                
                // Label
                const label = document.createElement('div');
                label.className = 'w-12 text-[10px] text-right mr-2 text-slate-400 font-bold uppercase';
                label.innerText = inst;
                row.appendChild(label);
                
                // Steps
                for (let i = 0; i < 16; i++) {
                    const step = document.createElement('div');
                    // Add grouping border every 4 steps
                    const margin = (i % 4 === 3 && i !== 15) ? 'mr-2' : '';
                    step.className = `w-8 h-8 rounded cursor-pointer bg-slate-700 hover:bg-slate-600 seq-step ${margin}`;
                    step.id = `seq-${rowIdx}-${i}`;
                    
                    // Restore state
                    if (sequencerState[rowIdx][i]) {
                        step.classList.add('active');
                    }
                    
                    step.onclick = () => {
                        sequencerState[rowIdx][i] = !sequencerState[rowIdx][i];
                        step.classList.toggle('active');
                    };
                    
                    row.appendChild(step);
                }
                grid.appendChild(row);
            });
        }
        
        // Initial Render
        renderSequencer();

        // --- Audio Init ---
        function initAudio() {
            if (isInit) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.5;
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            masterGain.connect(analyser);
            analyser.connect(audioCtx.destination);
            isInit = true;
            document.getElementById('status-text').innerText = "AUDIO ENGINE: ONLINE";
            document.getElementById('status-text').classList.replace('text-cyan-400', 'text-green-400');
            document.getElementById('status-light').classList.replace('bg-red-500', 'bg-green-500');
            drawVisualizer();
        }

        // --- Tab Switching ---
        function switchTab(tab) {
            // Stop Sequencer when switching away from pad
            if (currentTab === 'pad' && tab !== 'pad' && isPlaying) {
                toggleSequencer();
            }

            currentTab = tab;
            ['pad', 'keyboard', 'piano'].forEach(t => {
                const view = document.getElementById(`${t}-view`);
                const btn = document.getElementById(`tab-${t}`);
                const instr = document.getElementById(`instr-${t}`);
                if (view) view.classList.toggle('hidden', t !== tab);
                if (btn) btn.classList.toggle('active', t === tab);
                if (instr) instr.classList.toggle('hidden', t !== tab);
            });
        }
        function updateWaveform(val) { currentWaveform = val; }

        // --- Sequencer Logic (Scheduler) ---
        function nextNote() {
            const secondsPerBeat = 60.0 / tempo;
            // 16th note = 1/4 of a beat
            nextNoteTime += 0.25 * secondsPerBeat; 
            current16thNote++;
            if (current16thNote === 16) {
                current16thNote = 0;
            }
        }

        function scheduleNote(beatNumber, time) {
            // 1. Play Audio
            seqInstruments.forEach((inst, rowIdx) => {
                if (sequencerState[rowIdx][beatNumber]) {
                    if (sounds[inst]) {
                        sounds[inst](time);
                    }
                }
            });

            // 2. Schedule Visual Update (using setTimeout to sync loosely with audio time)
            // We use standard JS time for UI because WebAudio thread is separate
            const drawTime = (time - audioCtx.currentTime) * 1000;
            setTimeout(() => {
                // Clear previous highlights
                document.querySelectorAll('.seq-step.playing').forEach(el => el.classList.remove('playing'));
                
                // Highlight current column
                for(let r=0; r<6; r++) {
                    const el = document.getElementById(`seq-${r}-${beatNumber}`);
                    if (el) el.classList.add('playing');
                }
            }, Math.max(0, drawTime));
        }

        function scheduler() {
            // While there are notes that will play within the next interval
            while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(current16thNote, nextNoteTime);
                nextNote();
            }
            if (isPlaying) {
                timerID = window.setTimeout(scheduler, lookahead);
            }
        }

        function toggleSequencer() {
            initAudio(); // Ensure context is ready
            if (!audioCtx) return;

            isPlaying = !isPlaying;
            const btn = document.getElementById('btn-play');
            
            if (isPlaying) {
                // Start
                current16thNote = 0;
                nextNoteTime = audioCtx.currentTime + 0.1; // Start slight in future
                scheduler();
                btn.innerText = "STOP";
                btn.classList.replace('bg-green-600', 'bg-red-600');
                btn.classList.replace('hover:bg-green-500', 'hover:bg-red-500');
            } else {
                // Stop
                window.clearTimeout(timerID);
                btn.innerText = "PLAY";
                btn.classList.replace('bg-red-600', 'bg-green-600');
                btn.classList.replace('hover:bg-red-500', 'hover:bg-green-500');
                // Clear UI
                document.querySelectorAll('.seq-step.playing').forEach(el => el.classList.remove('playing'));
            }
        }

        function clearSequencer() {
            sequencerState = Array(6).fill().map(() => Array(16).fill(false));
            renderSequencer();
        }

        // BPM Slider
        document.getElementById('bpm-slider').addEventListener('input', function(e) {
            tempo = parseFloat(e.target.value);
            document.getElementById('bpm-display').innerText = tempo;
        });

        // --- Wrapper for Inputs ---
        function handleNoteInput(key) {
            if (currentTab === 'keyboard') noteOnSynth(key);
            if (currentTab === 'piano') noteOnPiano(key);
        }
        function handleNoteRelease(key) {
            if (currentTab === 'keyboard') noteOffSynth(key);
            if (currentTab === 'piano') noteOffPiano(key);
        }

        // --- PAD SOUNDS ---
        const sounds = {
            'kick': (t) => {
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                osc.connect(g); g.connect(masterGain);
                osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
                g.gain.setValueAtTime(1, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
                osc.start(t); osc.stop(t + 0.5);
            },
            'snare': (t) => {
                const b = audioCtx.createBuffer(1, audioCtx.sampleRate*0.5, audioCtx.sampleRate);
                const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const n = audioCtx.createBufferSource(); n.buffer=b;
                const f = audioCtx.createBiquadFilter(); f.type='highpass'; f.frequency.value=1000;
                const g = audioCtx.createGain(); n.connect(f); f.connect(g); g.connect(masterGain);
                g.gain.setValueAtTime(1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.2);
                n.start(t);
                const osc = audioCtx.createOscillator(); osc.type='triangle';
                const og = audioCtx.createGain(); osc.connect(og); og.connect(masterGain);
                osc.frequency.setValueAtTime(250, t); og.gain.setValueAtTime(0.5, t);
                og.gain.exponentialRampToValueAtTime(0.01, t+0.1); osc.start(t); osc.stop(t+0.2);
            },
            'hihat': (t) => {
                const b = audioCtx.createBuffer(1, audioCtx.sampleRate*0.1, audioCtx.sampleRate);
                const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const n = audioCtx.createBufferSource(); n.buffer=b;
                const bp = audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=10000;
                const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000;
                const g = audioCtx.createGain(); n.connect(bp); bp.connect(hp); hp.connect(g); g.connect(masterGain);
                g.gain.setValueAtTime(0.6, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.05); n.start(t);
            },
            'clap': (t) => {
                const b = audioCtx.createBuffer(1, audioCtx.sampleRate*0.2, audioCtx.sampleRate);
                const d = b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const n = audioCtx.createBufferSource(); n.buffer=b;
                const f = audioCtx.createBiquadFilter(); f.type='bandpass'; f.frequency.value=1500; f.Q.value=1;
                const g = audioCtx.createGain(); n.connect(f); f.connect(g); g.connect(masterGain);
                g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.8, t+0.01);
                g.gain.exponentialRampToValueAtTime(0.1, t+0.03); g.gain.linearRampToValueAtTime(0.6, t+0.04);
                g.gain.exponentialRampToValueAtTime(0.01, t+0.2); n.start(t);
            },
            'bass1': (t) => {
                const o = audioCtx.createOscillator(); o.type='sine'; const g = audioCtx.createGain();
                o.connect(g); g.connect(masterGain); o.frequency.setValueAtTime(55, t);
                g.gain.setValueAtTime(0.8, t); g.gain.setTargetAtTime(0, t, 0.2); o.start(t); o.stop(t+1);
            },
            'bass2': (t) => {
                const o = audioCtx.createOscillator(); o.type='sawtooth'; const f = audioCtx.createBiquadFilter();
                f.type='lowpass'; const g = audioCtx.createGain(); o.connect(f); f.connect(g); g.connect(masterGain);
                o.frequency.setValueAtTime(45, t); f.frequency.setValueAtTime(100, t);
                f.frequency.exponentialRampToValueAtTime(800, t+0.1); f.frequency.exponentialRampToValueAtTime(100, t+0.5);
                g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.5); o.start(t); o.stop(t+0.5);
            },
            'chord1': (t) => {
                [261.63, 329.63, 392.00, 493.88].forEach(f => {
                    const o = audioCtx.createOscillator(); o.type='triangle'; const g = audioCtx.createGain();
                    o.connect(g); g.connect(masterGain); o.frequency.value=f;
                    g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.15, t+0.05);
                    g.gain.exponentialRampToValueAtTime(0.001, t+1.5); o.start(t); o.stop(t+1.5);
                });
            },
            'chord2': (t) => {
                 [220.00, 261.63, 329.63, 392.00].forEach(f => {
                    const o = audioCtx.createOscillator(); o.type='sine'; const g = audioCtx.createGain();
                    o.connect(g); g.connect(masterGain); o.frequency.value=f;
                    g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.15, t+0.1);
                    g.gain.exponentialRampToValueAtTime(0.001, t+2); o.start(t); o.stop(t+2);
                });
            },
            'lead': (t) => {
                const o = audioCtx.createOscillator(); o.type='square'; const l = audioCtx.createOscillator(); l.frequency.value=5;
                const lg = audioCtx.createGain(); lg.gain.value=10; l.connect(lg); lg.connect(o.frequency);
                const g = audioCtx.createGain(); o.connect(g); g.connect(masterGain); o.frequency.value=660;
                g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0.1, t+0.1);
                g.gain.exponentialRampToValueAtTime(0.001, t+0.4); l.start(t); o.start(t); o.stop(t+0.4); l.stop(t+0.4);
            },
            'pad': (t) => {
                const o1 = audioCtx.createOscillator(); o1.type='sawtooth'; o1.frequency.value=440;
                const o2 = audioCtx.createOscillator(); o2.type='sawtooth'; o2.frequency.value=444;
                const f = audioCtx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=600;
                const g = audioCtx.createGain(); o1.connect(f); o2.connect(f); f.connect(g); g.connect(masterGain);
                g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.3, t+0.5);
                g.gain.exponentialRampToValueAtTime(0.001, t+3); o1.start(t); o2.start(t); o1.stop(t+3); o2.stop(t+3);
            },
            'laser': (t) => {
                const o = audioCtx.createOscillator(); o.type='sawtooth'; const g = audioCtx.createGain();
                o.connect(g); g.connect(masterGain); o.frequency.setValueAtTime(1200, t);
                o.frequency.exponentialRampToValueAtTime(100, t+0.3); g.gain.setValueAtTime(0.2, t);
                g.gain.exponentialRampToValueAtTime(0.01, t+0.3); o.start(t); o.stop(t+0.3);
            },
            'coin': (t) => {
                const o = audioCtx.createOscillator(); o.type='square'; const g = audioCtx.createGain();
                o.connect(g); g.connect(masterGain); o.frequency.setValueAtTime(987.77, t);
                o.frequency.setValueAtTime(1318.51, t+0.08); g.gain.setValueAtTime(0.1, t);
                g.gain.setValueAtTime(0.1, t+0.08); g.gain.linearRampToValueAtTime(0.01, t+0.4); o.start(t); o.stop(t+0.4);
            }
        };

        function playSound(type) {
            initAudio(); if(!audioCtx) return;
            const now = audioCtx.currentTime; if(sounds[type]) sounds[type](now);
            const btn = document.querySelector(`button[onclick="playSound('${type}')"]`);
            if (btn) { btn.classList.remove('btn-active'); void btn.offsetWidth; btn.classList.add('btn-active'); setTimeout(()=>btn.classList.remove('btn-active'), 100); }
        }

        // --- SYNTH LOGIC ---
        const activeSynthNotes = {};
        function noteOnSynth(key) {
            initAudio(); if (!audioCtx || activeSynthNotes[key]) return;
            const freq = pianoFrequencies[key]; if (!freq) return;
            const t = audioCtx.currentTime;
            
            const osc = audioCtx.createOscillator(); osc.type = currentWaveform; osc.frequency.setValueAtTime(freq, t);
            const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(2000, t);
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.3, t+0.05); gain.gain.linearRampToValueAtTime(0.2, t+0.2);
            
            osc.connect(filter); filter.connect(gain); gain.connect(masterGain); osc.start(t);
            activeSynthNotes[key] = { osc, gain };
            document.querySelectorAll(`.synth-keys-container div[data-note="${keyToNoteName[key]}"]`).forEach(el=>el.classList.add('active'));
        }
        function noteOffSynth(key) {
            if (!activeSynthNotes[key]) return;
            const { osc, gain } = activeSynthNotes[key]; const t = audioCtx.currentTime;
            gain.gain.cancelScheduledValues(t); gain.gain.setValueAtTime(gain.gain.value, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t+0.3); osc.stop(t+0.3);
            delete activeSynthNotes[key];
            document.querySelectorAll(`.synth-keys-container div[data-note="${keyToNoteName[key]}"]`).forEach(el=>el.classList.remove('active'));
        }

        // --- REALISTIC PIANO LOGIC ---
        // Uses Additive Synthesis: Fundamental + Detuned Unison + Harmonics + Hammer Noise
        const activePianoNotes = {};

        function noteOnPiano(key) {
            initAudio(); if (!audioCtx || activePianoNotes[key]) return;
            const freq = pianoFrequencies[key]; if (!freq) return;
            const t = audioCtx.currentTime;

            // 1. Hammer Noise (The Thump)
            const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.05, audioCtx.sampleRate);
            const noiseData = noiseBuffer.getChannelData(0);
            for(let i=0; i<noiseData.length; i++) noiseData[i] = Math.random()*2-1;
            const hammer = audioCtx.createBufferSource(); hammer.buffer = noiseBuffer;
            const hammerFilter = audioCtx.createBiquadFilter(); hammerFilter.type = 'lowpass'; hammerFilter.frequency.value = 800;
            const hammerGain = audioCtx.createGain();
            hammerGain.gain.setValueAtTime(0.4, t); hammerGain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
            hammer.connect(hammerFilter); hammerFilter.connect(hammerGain); hammerGain.connect(masterGain);
            hammer.start(t);

            // 2. Three detuned oscillators to simulate piano strings
            const oscs = [];
            const gains = [];
            
            const detunes = [0, 1.5, -1.5]; 
            
            detunes.forEach((cents, i) => {
                const osc = audioCtx.createOscillator();
                osc.type = i === 0 ? 'sine' : 'triangle'; // Mix sine and triangle for body
                
                // Frequency calculation
                osc.frequency.setValueAtTime(freq * Math.pow(2, cents/1200), t);
                
                const gain = audioCtx.createGain();
                
                const volume = i === 0 ? 0.5 : 0.2; // Fundamental is louder
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(volume, t + 0.01); // Instant attack
                gain.gain.exponentialRampToValueAtTime(0.01, t + 2.5); // Long natural decay
                
                osc.connect(gain);
                gain.connect(masterGain);
                osc.start(t);
                
                oscs.push(osc);
                gains.push(gain);
            });

            activePianoNotes[key] = { oscs, gains, hammer, hammerGain };
            document.querySelectorAll(`.piano-keys-container div[data-note="${keyToNoteName[key]}"]`).forEach(el=>el.classList.add('active'));
        }

        function noteOffPiano(key) {
            if (!activePianoNotes[key]) return;
            const { oscs, gains } = activePianoNotes[key];
            const t = audioCtx.currentTime;

            // Release phase
            gains.forEach(g => {
                g.gain.cancelScheduledValues(t);
                g.gain.setValueAtTime(g.gain.value, t);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.3); // Quick release when key lifted
            });
            
            oscs.forEach(o => o.stop(t + 0.3));

            delete activePianoNotes[key];
            document.querySelectorAll(`.piano-keys-container div[data-note="${keyToNoteName[key]}"]`).forEach(el=>el.classList.remove('active'));
        }

        // --- Global Event Listeners ---
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const key = e.key.toLowerCase();
            if (currentTab === 'pad') { if (padKeyMap[key]) playSound(padKeyMap[key]); }
            else { if (pianoFrequencies[key]) handleNoteInput(key); }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (currentTab !== 'pad') { if (pianoFrequencies[key]) handleNoteRelease(key); }
        });

        // --- Visualizer ---
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');
        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight;
            const bufferLength = analyser.frequencyBinCount; const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            canvasCtx.fillStyle = 'rgb(15, 23, 42)'; canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
            const barWidth = (canvas.width / bufferLength) * 2.5; let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 1.5;
                const r = barHeight + (25 * (i/bufferLength)); const g = 250 * (i/bufferLength);
                canvasCtx.fillStyle = `rgb(${r},${g},255)`;
                canvasCtx.fillRect(x, (canvas.height - barHeight) / 2, barWidth, barHeight);
                x += barWidth + 1;
            }
        }
        canvas.width = canvas.parentElement.offsetWidth; canvas.height = 150;

    </script>
</body>
</html>